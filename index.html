<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Compass to Target</title>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
    }

    #compass {
      width: 300px;
      height: 300px;
      border: 10px solid #333;
      border-radius: 50%;
      margin: 50px auto;
      position: relative;
      transform: rotate(0deg);
    }

    #needle {
      width: 4px;
      height: 140px;
      background: red;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%) rotate(0deg);
      transform-origin: bottom center;
    }
  </style>
</head>
<body>
  <h2>Compass to Target</h2>

  <input id="target-lat" type="number" step="any" value="21.422487" />
  <input id="target-lon" type="number" step="any" value="39.826206" />
  <br><br>
  <button onclick="setTarget()">Set Target</button>
  <button onclick="enableCompass()">Enable Compass</button>

  <div id="compass">
    <div id="needle"></div>
  </div>

  <div id="debug">
    <p><strong>Debug Info:</strong></p>
    <p id="debug-bearing">Bearing to Target: --</p>
    <p id="debug-heading">Compass Heading: --</p>
    <p id="debug-direction">Needle Rotation: --</p>
  </div>

  <script>
    let targetLat = 21.422487;
    let targetLon = 39.826206;
    let userLat, userLon;

    function setTarget() {
      targetLat = parseFloat(document.getElementById("target-lat").value);
      targetLon = parseFloat(document.getElementById("target-lon").value);
    }

    function getBearing(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;

      const φ1 = toRad(lat1);
      const φ2 = toRad(lat2);
      const Δλ = toRad(lon2 - lon1);

      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1) * Math.sin(φ2) -
                Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
      const θ = Math.atan2(y, x);

      return (toDeg(θ) + 360) % 360;
    }

    function updateNeedle(heading) {
      if (userLat == null || userLon == null || heading == null) return;

      const bearing = getBearing(userLat, userLon, targetLat, targetLon);
      const rotation = (bearing - heading + 360) % 360;

      document.getElementById("compass").style.transform = `rotate(${-heading}deg)`;
      document.getElementById("needle").style.transform = `rotate(${rotation}deg)`;

      document.getElementById("debug-bearing").textContent = `Bearing to Target: ${bearing.toFixed(2)}°`;
      document.getElementById("debug-heading").textContent = `Compass Heading: ${heading.toFixed(2)}°`;
      document.getElementById("debug-direction").textContent = `Needle Rotation: ${rotation.toFixed(2)}°`;
    }

    function enableCompass() {
      navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
      });

      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS
        DeviceOrientationEvent.requestPermission()
          .then(permission => {
            if (permission === 'granted') {
              window.addEventListener('deviceorientation', handleOrientation, true);
            } else {
              alert("Compass permission denied.");
            }
          }).catch(console.error);
      } else {
        // Android or older browsers
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        window.addEventListener('deviceorientation', handleOrientation, true);
      }
    }

    function handleOrientation(event) {
      let heading;

      if (event.absolute && event.alpha != null) {
        heading = event.alpha;
      }

      if (typeof event.webkitCompassHeading !== 'undefined') {
        heading = event.webkitCompassHeading;
      }

      if (heading != null) {
        heading = (360 - heading) % 360;
        updateNeedle(heading);
      }
    }
  </script>
</body>
</html>