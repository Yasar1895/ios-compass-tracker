<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compass to Target</title>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
    }

    #compass-container {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 40px auto;
    }

    #compass {
      width: 100%;
      height: 100%;
      border: 10px solid #333;
      border-radius: 50%;
      position: absolute;
      top: 0;
      left: 0;
      transform: rotate(0deg);
      transition: transform 0.3s ease-out;
    }

    #needle {
      width: 4px;
      height: 50%;
      background-color: red;
      position: absolute;
      top: 25%;
      left: 50%;
      transform-origin: bottom center;
      transform: rotate(0deg);
      transition: transform 0.3s ease-out;
    }

    input {
      width: 120px;
      padding: 5px;
      margin: 10px;
    }

    #debug {
      margin-top: 20px;
      font-size: 14px;
      background: #f1f1f1;
      padding: 10px;
      border-radius: 8px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Compass to Target</h2>

  <input id="target-lat" type="number" step="any" placeholder="Latitude" />
  <input id="target-lon" type="number" step="any" placeholder="Longitude" />
  <br />
  <button onclick="setTarget()">Set Target</button>
  <button onclick="enableCompass()">Enable Compass</button>

  <div id="compass-container">
    <div id="compass"></div>
    <div id="needle"></div>
  </div>

  <div id="debug">
    <strong>Debug Info:</strong><br>
    Location:<br>
    <span id="debug-bearing"></span><br>
    <span id="debug-heading"></span><br>
    <span id="debug-direction"></span>
  </div>

  <script>
    let targetLat = 21.422487;  // Default: Kaaba
    let targetLon = 39.826206;
    let userLat, userLon;

    function setTarget() {
      targetLat = parseFloat(document.getElementById("target-lat").value);
      targetLon = parseFloat(document.getElementById("target-lon").value);
    }

    function getBearing(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;

      const φ1 = toRad(lat1);
      const φ2 = toRad(lat2);
      const Δλ = toRad(lon2 - lon1);

      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1) * Math.sin(φ2) -
                Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
      const θ = Math.atan2(y, x);

      return (toDeg(θ) + 360) % 360;
    }

    function updateNeedle(heading) {
      if (userLat == null || userLon == null) return;

      const bearing = getBearing(userLat, userLon, targetLat, targetLon);
      const rotation = (bearing - heading + 360) % 360;

      // Rotate compass to match device orientation
      document.getElementById("compass").style.transform = `rotate(${-heading}deg)`;

      // Rotate needle relative to the compass
      document.getElementById("needle").style.transform = `rotate(${rotation}deg)`;

      // Debug Info
      document.getElementById("debug-bearing").textContent = `Bearing to Target: ${bearing.toFixed(2)}°`;
      document.getElementById("debug-heading").textContent = `Compass Heading: ${heading.toFixed(2)}°`;
      document.getElementById("debug-direction").textContent = `Needle Rotation: ${rotation.toFixed(2)}°`;
    }

    function enableCompass() {
      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              window.addEventListener('deviceorientationabsolute', handleOrientation, true);
              window.addEventListener('deviceorientation', handleOrientation, true);
            }
          })
          .catch(console.error);
      } else {
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        window.addEventListener('deviceorientation', handleOrientation, true);
      }

      navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
      }, console.error, { enableHighAccuracy: true });
    }

    function handleOrientation(event) {
      const heading = event.alpha != null ? 360 - event.alpha : 0;
      updateNeedle(heading);
    }
  </script>
</body>
</html>