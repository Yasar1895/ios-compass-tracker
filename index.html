<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>iOS Compass to Kaaba</title>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
    }
    #compass {
      width: 300px;
      height: 300px;
      border: 10px solid #333;
      border-radius: 50%;
      margin: 30px auto;
      position: relative;
    }
    #needle {
      width: 4px;
      height: 140px;
      background: red;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      transform-origin: bottom center;
    }
    #info {
      font-size: 16px;
      margin-top: 20px;
      white-space: pre-line;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>Compass to Kaaba</h2>
  <div id="compass">
    <div id="needle"></div>
  </div>

  <div id="info">Waiting for permission...</div>
  <button id="startBtn">Start Compass</button>

  <script>
    const needle = document.getElementById('needle');
    const info = document.getElementById('info');
    const startBtn = document.getElementById('startBtn');

    const KAABA_LAT = 21.4225;
    const KAABA_LON = 39.8262;

    let userLat = null;
    let userLon = null;

    function degToRad(deg) {
      return deg * Math.PI / 180;
    }

    function radToDeg(rad) {
      return rad * 180 / Math.PI;
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = degToRad(lon2 - lon1);
      lat1 = degToRad(lat1);
      lat2 = degToRad(lat2);
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1) * Math.sin(lat2) -
                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
      return (radToDeg(Math.atan2(y, x)) + 360) % 360;
    }

    function updateCompass(heading) {
      if (userLat === null || userLon === null) return;
      const bearingToKaaba = calculateBearing(userLat, userLon, KAABA_LAT, KAABA_LON);
      const rotation = bearingToKaaba - heading;
      needle.style.transform = `translateX(-50%) rotate(${rotation}deg)`;

      info.innerText = `Your Lat: ${userLat.toFixed(5)}\nYour Lon: ${userLon.toFixed(5)}
Heading: ${heading.toFixed(2)}°\nKaaba Bearing: ${bearingToKaaba.toFixed(2)}°
Needle Rotation: ${rotation.toFixed(2)}°`;
    }

    function startCompass() {
      // Get location
      navigator.geolocation.watchPosition((pos) => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
      }, (err) => {
        info.innerText = "Location error: " + err.message;
      }, {
        enableHighAccuracy: true,
        maximumAge: 1000
      });

      // iOS deviceorientation permission
      if (typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission()
          .then((response) => {
            if (response === "granted") {
              window.addEventListener("deviceorientationabsolute", handleOrientation, true);
              window.addEventListener("deviceorientation", handleOrientation, true);
            } else {
              info.innerText = "Permission denied for orientation.";
            }
          }).catch(console.error);
      } else {
        // Android or non-iOS
        window.addEventListener("deviceorientationabsolute", handleOrientation, true);
        window.addEventListener("deviceorientation", handleOrientation, true);
      }
    }

    function handleOrientation(event) {
      const heading = event.alpha;
      if (heading !== null) {
        updateCompass(heading);
      }
    }

    startBtn.addEventListener('click', () => {
      startBtn.style.display = 'none';
      startCompass();
    });
  </script>
</body>
</html>